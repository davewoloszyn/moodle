{"version":3,"file":"mediadetails.min.js","sources":["../../src/embed/mediadetails.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny media plugin media details class for embed.\n *\n * @module      tiny_media/embed/mediadetails\n * @copyright   2024 Stevani Andolo <stevani@hotmail.com.au>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {alert} from 'core/notification';\nimport Selectors from '../selectors';\nimport {component} from '../common';\nimport {getString} from 'core/str';\nimport {\n    sourceTypeChecked,\n    getFileName,\n    stopMediaLoading,\n} from '../helpers';\nimport {MediaHandler} from './mediahandler';\nimport {MediaBase} from '../mediabase';\n\nexport class MediaDetails extends MediaBase {\n\n    selectorType = 'EMBED';\n\n    isEmbedPreviewDeleted = false;\n\n    constructor(data) {\n        super();\n        for (const property in data) {\n            const value = data[property];\n            if (typeof value !== 'function') {\n                this[property] = data[property];\n            }\n        }\n    }\n\n    /**\n     * Init the media details preview.\n     */\n    init = async() => {\n        this.currentModal.setTitle(getString('mediadetails', component));\n        sourceTypeChecked({\n            source: this.mediaSource,\n            root: this.root,\n            urlSelector: Selectors.EMBED.elements.fromUrl,\n            fileNameSelector: Selectors.EMBED.elements.fileNameLabel,\n        });\n        this.setMediaSourceAndPoster();\n        this.registerMediaDetailsEventListeners(this.currentModal);\n    };\n\n    /**\n     * Sets media source and thumbnail for the video.\n     */\n    setMediaSourceAndPoster = () => {\n        const box = this.root.querySelector(Selectors.EMBED.elements.previewBox);\n        const preview = this.root.querySelector(Selectors.EMBED.elements.preview);\n        preview.src = this.mediaSource;\n        preview.innerHTML = this.mediaSource;\n\n        if (['video', 'audio'].includes(this.mediaType)) {\n            let fileName = getFileName(this.root); // Get original filename.\n            if (this.isUpdating) {\n                if (!this.isEmbedPreviewDeleted) {\n                    fileName = this.mediaTitle; // Title from the selected media.\n                }\n            }\n\n            // Set the media name/title.\n            this.root.querySelector(Selectors.EMBED.elements.title).value = fileName;\n        }\n\n        if (this.mediaType === 'video') {\n            let videoHeight = null;\n            let videoWidth = null;\n            const videoTag = document.querySelector(Selectors.EMBED.elements.videoTag);\n\n            if (this.thumbnail) {\n                videoTag.poster = this.thumbnail;\n            }\n            videoTag.load();\n\n            preview.addEventListener('error', async() => {\n                alert(\n                    await getString('urlnotavailable', component),\n                    await getString('urlnotavailabledesc', component, this.mediaSource)\n                );\n\n                stopMediaLoading(this.root, 'EMBED');\n\n                const mediaHandler = new MediaHandler();\n                mediaHandler.resetUploadForm();\n                return;\n            });\n\n            videoTag.addEventListener('loadedmetadata', () => {\n                videoHeight = videoTag.videoHeight;\n                videoWidth = videoTag.videoWidth;\n                const widthProportion = (videoWidth - videoHeight);\n                const isLandscape = widthProportion > 0;\n\n                // Store dimensions of the raw video.\n                this.mediaDimensions = {\n                    width: videoWidth,\n                    height: videoHeight,\n                };\n\n                // Set the media preview based on the media dimensions.\n                if (isLandscape) {\n                    videoTag.width = box.offsetWidth;\n                } else {\n                    videoTag.height = box.offsetHeight;\n                }\n            });\n\n            videoTag.addEventListener('canplay', () => {\n                const height = this.root.querySelector(Selectors.EMBED.elements.height);\n                const width = this.root.querySelector(Selectors.EMBED.elements.width);\n\n                if (height.value === '' && width.value === '') {\n                    height.value = videoHeight;\n                    width.value = videoWidth;\n                }\n\n                // Size checking and adjustment.\n                if (videoHeight === parseInt(height.value) && videoWidth === parseInt(width.value)) {\n                    this.currentWidth = this.mediaDimensions.width;\n                    this.currentHeight = this.mediaDimensions.height;\n                    this.sizeChecked('original');\n                } else {\n                    this.currentWidth = parseInt(width.value);\n                    this.currentHeight = parseInt(height.value);\n                    this.sizeChecked('custom');\n                }\n            });\n        } else if (this.mediaType === 'audio') {\n            const audioTag = this.root.querySelector(Selectors.EMBED.elements.audioTag);\n            audioTag.load();\n        } else {\n            // Set iframe width/height = box width/height.\n            preview.width = box.offsetWidth;\n            preview.height = box.offsetHeight;\n        }\n    };\n\n    /**\n     * Only registers event listeners for new loaded elements in mediaDetails.\n     */\n    registerMediaDetailsEventListeners = async() => {\n        // Handle media autoplay and mute.\n        const autoPlay = this.root.querySelector(Selectors.EMBED.elements.mediaAutoplay);\n        const mute = this.root.querySelector(Selectors.EMBED.elements.mediaMute);\n        if (autoPlay && mute && this.mediaType === 'link') {\n            autoPlay.addEventListener('change', () => {\n                if (autoPlay.checked) {\n                    mute.checked = true;\n                }\n            });\n\n            mute.addEventListener('change', () => {\n                if (autoPlay.checked && !mute.checked) {\n                    autoPlay.checked = false;\n                }\n            });\n        }\n\n        // Handle the original size when selected.\n        const sizeOriginalEle = this.root.querySelector(Selectors.EMBED.elements.sizeOriginal);\n        if (sizeOriginalEle) {\n            sizeOriginalEle.addEventListener('change', () => {\n                this.sizeChecked('original');\n            });\n        }\n\n        // Handle the custom size when selected.\n        const sizeCustomEle = this.root.querySelector(Selectors.EMBED.elements.sizeCustom);\n        if (sizeCustomEle) {\n            sizeCustomEle.addEventListener('change', () => {\n                this.sizeChecked('custom');\n            });\n        }\n\n        // Handle the custom with size when inputted.\n        const widthEle = this.root.querySelector(Selectors.EMBED.elements.width);\n        if (widthEle) {\n            widthEle.addEventListener('input', () => {\n                // Avoid empty value.\n                widthEle.value = widthEle.value === \"\" ? 0 : Number(widthEle.value);\n                this.autoAdjustSize();\n            });\n        }\n\n        // Handle the custom height size when inputted.\n        const heightEle = this.root.querySelector(Selectors.EMBED.elements.height);\n        if (heightEle) {\n            heightEle.addEventListener('input', () => {\n                // Avoid empty value.\n                heightEle.value = heightEle.value === \"\" ? 0 : Number(heightEle.value);\n                this.autoAdjustSize(true);\n            });\n        }\n    };\n}\n"],"names":["MediaDetails","MediaBase","constructor","data","async","currentModal","setTitle","component","source","this","mediaSource","root","urlSelector","Selectors","EMBED","elements","fromUrl","fileNameSelector","fileNameLabel","setMediaSourceAndPoster","registerMediaDetailsEventListeners","box","querySelector","previewBox","preview","src","innerHTML","includes","mediaType","fileName","isUpdating","isEmbedPreviewDeleted","mediaTitle","title","value","videoHeight","videoWidth","videoTag","document","thumbnail","poster","load","addEventListener","MediaHandler","resetUploadForm","isLandscape","mediaDimensions","width","height","offsetWidth","offsetHeight","parseInt","currentWidth","currentHeight","sizeChecked","audioTag","autoPlay","mediaAutoplay","mute","mediaMute","checked","sizeOriginalEle","sizeOriginal","sizeCustomEle","sizeCustom","widthEle","Number","autoAdjustSize","heightEle","property"],"mappings":"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"}